<%-include("header")%>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>
        <% if(file.price==0) { %>
            <%= file.filename || 'File Download' %> • Download | Vidyari
        <% } else { %>
            <%= file.filename || 'File Checkout' %> • Secure Checkout | Vidyari
        <% } %>
    </title>

    <meta name="description"
        content="Securely purchase and instantly download '<%= file.filename %>'. <%= file.filedescription %> | Vidyari Checkout">
    <meta property="og:type" content="product">
    <meta property="og:title" content="Checkout • <%= file.filename %> | Vidyari">
    <meta property="og:image" content="<%= previewUrl || 'https://vidyari.com/images/logo-1200x630.png' %>">

    <link rel="icon" href="/images/logo.svg" type="image/svg" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- Root and Base Styles --- */
        :root {
            --font-main: 'Inter', sans-serif;
            --font-display: 'Anton', sans-serif;
            --color-black: #000;
            --color-white: #fff;
            --color-accent: #1ac2ff; 
            --color-primary-card: #ff66a3; 
            --color-sidebar: #f0f0f0; 
            --color-paid: #E84C86;
            --color-free: #30B45E;
        }

        html, body {
            width: 100%;
            height: 100%;
        }
        body {
            background-color: var(--color-black);
            color: var(--color-white);
            font-family: var(--font-main);
            overflow-x: hidden;
            font-size: 1rem; 
        }
        
        main {
            /* padding: 0 !important;  */
        }

        .container-xl {
            /* max-width: 1300px;  */
            width: 100%;
            /* height: 100vh; */
            /* margin: 0 auto; */
            /* padding-top: 3rem;  */
            /* padding-bottom: 3rem;  */
        }
        
        /* --- High-Contrast Block Styling --- */
        .product-block {
            background-color: var(--color-white);
            color: var(--color-black);
            /* border: 6px solid var(--color-black); */
            box-shadow: 15px 15px 0 var(--color-black); 
            padding: 1.5rem; 
            /* margin-bottom: 3rem; */
        }

        /* --- Typography --- */
        h1 {
            font-family: var(--font-display);
            text-transform: uppercase;
            font-size: clamp(2.2rem, 5vw, 3.5rem);
            margin-bottom: 0.5rem;
            line-height: 1.1;
        }
        
        /* --- Product Details and Spacing --- */
        .details-box { 
            border: 2px dashed var(--color-black); 
            padding: 1.5rem; 
            margin-top: 2rem; 
            line-height: 1.7; 
            background-color: #fcfcfc; 
        }
        .details-box h2 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            border-bottom: 2px solid var(--color-black); 
            padding-bottom: 5px; 
            margin-bottom: 1rem;
        }
        .details-box p, 
        .details-box ul, 
        .details-box ol, 
        .details-box blockquote {
            margin-bottom: 1rem; 
        }

        /* --- Image Previews --- */
        .preview-image-wrapper {
            width: 100%; 
            max-width: 380px; 
            aspect-ratio: 1 / 1.414; 
            position: relative; 
            border: 4px solid var(--color-black); 
            box-shadow: 8px 8px 0 rgba(0,0,0,0.5); 
            overflow: hidden;
            margin: 0 auto 1.5rem auto; 
            background-color: #eee;
            cursor: zoom-in; /* Indicate clickable for zoom */
        }
        .preview-image-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
        
        /* Style for the new image modal - OPTIMIZED FOR FULL, CLEAR VIEW */
        #imageModal .modal-dialog {
            display: flex; /* Flexbox for centering */
            align-items: center; /* Vertically center */
            justify-content: center; /* Horizontally center */
            margin: 0;
            width: 100%;
            height: 100%;
            padding: 0 !important;
        }
        #imageModal .modal-content {
            background-color: rgba(0, 0, 0, 0.95); /* Deeper black background */
            border: none;
            width: 100%;
            height: 100%;
        }
        #imageModal .modal-header {
            position: fixed; /* Keep close button visible */
            top: 0;
            right: 0;
            z-index: 1056; /* Above the image */
            border-bottom: none;
            padding: 1rem;
        }
        #imageModal .modal-body {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px; /* Small padding buffer */
            overflow: auto; /* Allow scrolling if image is truly huge */
            flex-grow: 1;
        }
        #imageModal img {
            /* Key for no cut: object-fit: contain */
            object-fit: contain;
            max-height: 100%; /* Fill 100% of the modal body height */
            max-width: 100%;  /* Fill 100% of the modal body width */
            width: auto;      /* Maintain aspect ratio */
            height: auto;     /* Maintain aspect ratio */
            display: block;
            
            /* Animation for smooth zoom */
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Smoother transition curve */ 
            transform: scale(0.85); /* Initial scale for distinct zoom-in effect */
        }
        #imageModal.show #modalFullImage {
            transform: scale(1); /* Final scale when modal is shown (100% size) */
        }
        #imageModal .btn-close {
            filter: invert(1);
            opacity: 1;
            box-shadow: none; /* Clean up button focus */
        }

        /* --- Creator Info --- */
        .creator-info { display: flex; align-items: center; gap: 10px; margin-bottom: 1rem; }
        .creator-info .profile-pic { 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            border: 3px solid var(--color-black); 
            object-fit: cover;
            flex-shrink: 0;
        }
        .category-tag {
            display: inline-block; background-color: var(--color-primary-card); color: var(--color-black); padding: 0.2rem 0.6rem; font-size: 0.8rem; font-weight: 900; text-transform: uppercase; border: 2px solid var(--color-black); box-shadow: 2px 2px 0 var(--color-black); margin-bottom: 0.5rem;
        }
        /* New styles for improved details layout */
        .spec-list {
            list-style: none;
            padding: 0;
            margin: 0.5rem 0 1rem 0;
        }
        .spec-list li {
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--color-black);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .spec-list li span {
            font-weight: 400;
            color: #333;
        }

        /* --- Buy Box (Sidebar) --- */
        .buy-action-sidebar {
            border: 4px solid var(--color-black);
            padding: 1.5rem;
            background-color: var(--color-sidebar); 
            /* box-shadow: 10px 10px 0 var(--color-black); */
            position: sticky; 
            top: 20px;
        }
        .price-large {
            font-family: var(--font-display);
            font-size: 3.5rem;
            color: var(--color-paid); 
            line-height: 1;
            margin-top: 1rem;
        }
        .buy-action-sidebar .btn-action {
            border: 3px solid var(--color-black); 
            background: var(--color-accent); 
            color: var(--color-black); 
            padding: 1rem;
            font-size: 1.25rem; 
            font-weight: 900;
            text-transform: uppercase; 
            box-shadow: 6px 6px 0 var(--color-black);
            transition: all 0.1s;
            text-decoration: none;
        }
        .buy-action-sidebar .btn-action:hover {
            transform: translate(1px, 1px);
            box-shadow: 4px 4px 0 var(--color-black);
            background: var(--color-primary-card);
        }

        /* --- Related Documents Styling - GRID --- */
        .related-header {
            font-family: var(--font-display); 
            text-transform: uppercase;
            font-size: clamp(1.8rem, 4vw, 2.8rem);
            border-bottom: 4px solid var(--color-black); 
            padding-bottom: 10px;
            margin-bottom: 1.5rem;
        }
        
        /* Base setting for larger screens (usually 3+ columns) */
        .related-grid { 
            display: grid;
            /* Responsive grid: minimum card width 180px for tablets/desktops */
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
            gap: 20px;
            padding: 5px 0; 
            margin-bottom: 20px; 
        }

        /* MEDIA QUERY: Force 2 cards per row on narrow screens (e.g., phones < 576px) */
        @media (max-width: 575.98px) {
            .related-grid {
                 /* Set min width lower and reduce gap to ensure 2 columns fit */
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
                gap: 10px; 
            }
        }
        
        .file-card-wrapper { 
            width: 100%; 
            display: block;
            text-decoration: none;
        }
        .file-card {
            border: 3px solid var(--color-black); 
            box-shadow: 4px 4px 0 var(--color-black); 
            background: var(--color-primary-card);
            height: 100%; 
            display: flex; 
            flex-direction: column;
            text-decoration: none;
        }
        .file-card .card-img {
            aspect-ratio: 1 / 1.414; 
            position: relative; 
            overflow: hidden;
            background-color: var(--color-white);
            padding: 5px;
        }
        .file-card .card-img img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            display: block;
        }
        .file-card .detail-bar {
            min-height: 40px; 
            padding: 6px 8px; 
            border-top: 3px solid var(--color-black); 
            background: var(--color-white); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-shrink: 0;
        }
        .file-card .file-title-related {
            font-size: 0.85rem; 
            font-weight: 700; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            flex-grow: 1; 
            color: var(--color-black);
        }
        .file-card .stats-overlay {
            position: absolute; top: 0; left: 0; padding: 5px 8px; font-size: 0.7rem; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); background: linear-gradient(to bottom, rgba(0,0,0,0.5), rgba(0,0,0,0)); z-index: 5;
        }
        .file-card .price-badge-related {
            padding: 2px 5px; border: 2px solid var(--color-black); font-weight: 900; font-size: 0.55rem; box-shadow: 1px 1px 0 var(--color-black); text-transform: uppercase; flex-shrink: 0;
        }
    </style>
</head>

<body>
    <% 
    // Helper function for formatting file size
    const formatBytes=(bytes, decimals=2)=> {
        if (!+bytes) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes=['Bytes', 'KB' , 'MB' , 'GB' , 'TB' ];
        const i=Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
    }; 
    %>

    <main>
        <div class="container-">
            <div class="product-block">
                <div class="row g-5">

                    <div class="col-lg-8">
                        <div class="row g-4">
                            
                            <div class="col-lg-5 col-xl-4">
                                <div class="preview-image-wrapper" data-bs-toggle="modal" data-bs-target="#imageModal">
                                    <img 
                                        id="mainPreviewImage"
                                        src="<%= (previewUrl && typeof previewUrl === 'string' && previewUrl.trim() !== '') ? previewUrl : '/images/File_Demo.svg' %>" 
                                        alt="Preview of <%= file.filename %>" 
                                        onerror="this.onerror=null;this.src='/images/File_Demo.svg';"
                                    >
                                </div>
                                
                                <div class="details-box p-3 mt-3 d-lg-none">
                                    <h2 class="h6 fw-bold text-uppercase mb-2">File Specifications</h2>
                                    <ul class="spec-list small">
                                        <li>File Type: <span><i class="fas fa-file me-1"></i> <%= file.fileType || 'PDF' %></span></li>
                                        <li>File Size: <span><i class="fas fa-box-open me-1"></i> <%= file.fileSize ? formatBytes(file.fileSize) : 'N/A' %></span></li>
                                        <li>Added on: <span><%= new Date(file.createdAt).toLocaleDateString() %></span></li>
                                    </ul>
                                </div>
                            </div>

                            <div class="col-lg-7 col-xl-8">
                                <span class="category-tag"><%= file.category || 'Notes' %></span>
                                
                                <h1><%- file.filename || 'Untitled Document' %></h1>
                                
                                <div class="creator-info">
                                    <img src="<%= sellerprofilepic || '/images/avatar.jpg' %>" alt="Creator" class="profile-pic"/>
                                    <span class="small text-muted">by</span>
                                    <a href="/profile/<%= file.user || 'admin' %>" class="fw-bold text-decoration-none text-dark">
                                        <%= file.user || 'Vidyari Team' %>
                                        <% if (ISVERIFIED) { %>
                                <img style="width: 20px; height: 20px;" src="/images/verify.png" alt="Verified Badge"/>
                            <% } %>
                                    </a>
                                </div>
                                
                                <div class="stats-detail d-flex align-items-center gap-4 py-2 border-top border-bottom border-dark my-3">
                                    <span class="file-meta-item fw-bold" title="Rating">
                                        <i class="fas fa-star text-warning me-1"></i> 4.5/5.0
                                    </span>
                                    <span class="text-muted">|</span>
                                    <span class="file-meta-item fw-bold" title="Total Downloads">
                                        <i class="fas fa-download me-1"></i>
                                        <%= (file.downloadCount || 0).toLocaleString() %> Downloads
                                    </span>
                                </div>

                                <div class="d-flex align-items-center gap-3 mb-4">
                                    <span class="LikesBtn-file file-meta-item"></span>
                                </div>

                                <div class="details-box p-3 d-none d-lg-block">
                                    <h2 class="h6 fw-bold text-uppercase mb-2">File Specifications</h2>
                                    <ul class="spec-list small">
                                        <li>File Type: <span><i class="fas fa-file me-1"></i> <%= file.fileType || 'PDF' %></span></li>
                                        <li>File Size: <span><i class="fas fa-box-open me-1"></i> <%= file.fileSize ? formatBytes(file.fileSize) : 'N/A' %></span></li>
                                        <li>Added on: <span><%= new Date(file.createdAt).toLocaleDateString() %></span></li>
                                    </ul>
                                </div>
                                
                            </div>
                        </div>

                        <% if (file.filedescription) { %>
                            <div class="details-box mt-4">
                                <h2 class="h5 fw-bold text-uppercase">Product Description</h2>
                                <div class="product-description-content">
                                    <%-file.filedescription %>
                                </div>
                            </div>
                        <% } %>
                        
                        <div class="mt-4">
                            <%- include("reporttemplate") %>
                        </div>
                    </div> 

                    <div class="col-lg-4">
                        <div class="buy-action-sidebar">
                            
                            <div class="d-flex flex-column align-items-center justify-content-center py-2 mb-3">
                                <span class="h5 fw-bold text-uppercase text-center">Price:</span>
                                <% if (Number(file.price) === 0) { %>
                                    <span class="price-large" style="color: var(--color-free);">FREE</span>
                                <% } else { %>
                                    <span class="price-large">₹<%= Number(file.price).toLocaleString('en-IN') %></span>
                                <% } %>
                            </div>
                            
                            <hr style="border-top: 3px solid var(--color-black); margin: 1.5rem 0;">
                            
                            <% if (Number(file.price) > 0) { %>
                                <button id="rzp-button" class="btn-action w-100 d-flex align-items-center justify-content-center gap-2" type="button">
                                    <i class="fa-solid fa-cart-shopping"></i>
                                    <span>Secure Checkout </span>
                                </button>
                            <% } else { %>
                                <a href="/download?file_id=<%=file._id%>" class="btn-action w-100 d-flex align-items-center justify-content-center gap-2" id="downloadBtn">
                                    <i class="fa-solid fa-download"></i>
                                    <span>Instant Download</span>
                                </a>
                            <% } %>

                            <ul class="trust-badges-list small fw-bold mt-4 pt-3 border-top border-dark">
                                <li><i class="fas fa-check-circle me-2" style="color: var(--color-paid);"></i>Instant Digital Access</li>
                                <li><i class="fas fa-lock me-2" style="color: var(--color-paid);"></i>Secure Checkout Guaranteed</li>
                                <li><i class="fas fa-shield-alt me-2" style="color: var(--color-paid);"></i>Seller Verified</li>
                            </ul>
                            
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="product-block related-section">
                <span class="related-header">More Like This</span>
                
                <div class="related-grid" id="relatedGrid"> 
                    <p id="gridLoading" class="text-dark ps-2">Loading similar files...</p>
                </div>
            </div>
            
            <%- include("chat") %>

        </div>
    </main>
    
    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <img id="modalFullImage" src="" alt="Full preview of <%= file.filename %>">
                </div>
            </div>
        </div>
    </div>
    
    <%- include('footer') %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
// JavaScript slugify function
const slugifyJS = (text) => text ? text.toLowerCase().trim().replace(/\s+/g, '-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-') : 'file';

// Define single render function for all dynamic JS use, relying fully on CSS classes
const renderFileCardJS = (doc) => {
    const slugify = slugifyJS;
    const fileUrl = `/file/${doc.slug || slugify(doc.filename)}/${doc._id}`;
    const priceBadgeText = doc.price > 0 ? `₹${doc.price}` : `FREE`;
    const priceBadgeClass = doc.price > 0 ? `badge-paid` : `badge-free`;

    // Returns the raw card HTML, relying on defined CSS classes for all styling
    return `
        <a href="${fileUrl}" class="file-card-wrapper">
            <div class="file-card">
                <div class="card-img">
                    <div class="stats-overlay">
                        <span class="stats-item" title="Creator"><i class="fas fa-user me-1"></i> ${doc.user || 'Admin'}</span>
                    </div>
                <img 
    src="${doc.previewUrl && typeof doc.previewUrl === 'string' && doc.previewUrl.trim() !== '' ? doc.previewUrl : '/images/File_Demo.svg'}" 
    alt="${doc.filename}" 
    loading="lazy"
    onerror="this.onerror=null;this.src='/images/File_Demo.svg';"
/>


                </div>
                <div class="detail-bar">
                    <span class="file-title-related" title="${doc.filename}">${doc.filename}</span>
                    <span class="price-badge-related ${priceBadgeClass}">${priceBadgeText}</span>
                </div>
            </div>
        </a>
    `;
};


document.addEventListener('DOMContentLoaded', function() {
    // --- Data and Constants ---
    const currentFileId = "<%= file._id %>";
    const relatedGrid = document.getElementById('relatedGrid'); 
    
    // --- Image Modal Setup ---
    const mainPreviewImage = document.getElementById('mainPreviewImage');
    const modalFullImage = document.getElementById('modalFullImage');
    const imageModalElement = document.getElementById('imageModal');

    if (imageModalElement && mainPreviewImage) {
        // Use Bootstrap's native event to set the image source when the modal is about to open
        imageModalElement.addEventListener('show.bs.modal', function (event) {
            // Get the source from the main preview image
            const imageSrc = mainPreviewImage.src; 
            if (modalFullImage) {
                modalFullImage.src = imageSrc;
            }
        });
    }

    // --- Liking Logic ---
    const likeBtnfile = document.querySelector(".LikesBtn-file");
    if (likeBtnfile) {
        let fileLikes = <%= file.likes %>;
        let allFiles = JSON.parse(localStorage.getItem("fileData")) || {};

        function updateLikeButton() {
            if (allFiles[currentFileId] && allFiles[currentFileId].liked) {
                likeBtnfile.innerHTML = `<i class="fa-solid fa-thumbs-up" style="color: var(--color-primary-card);"></i> ${fileLikes} Likes`;
            } else {
                likeBtnfile.innerHTML = `<i class="fa-regular fa-thumbs-up"></i> ${fileLikes} Likes`;
            }
        }
        updateLikeButton();
        likeBtnfile.onclick = function () { 
            if (allFiles[currentFileId] && allFiles[currentFileId].liked) {
                fileLikes--;
                allFiles[currentFileId].liked = false;
                fetch(`/files/impression/${currentFileId}/dislike`).catch(err => console.error(err));
            } else {
                fileLikes++;
                if (!allFiles[currentFileId]) allFiles[currentFileId] = {};
                allFiles[currentFileId].liked = true;
                fetch(`/files/impression/${currentFileId}/like`).catch(err => console.error(err));
            }
            localStorage.setItem("fileData", JSON.stringify(allFiles));
            updateLikeButton();
        };
    }
    
    // --- Buy Button Logic ---
    const buyButton = document.getElementById('rzp-button');
    if (buyButton) {
        buyButton.onclick = function (e) {
            window.location.href = "/checkout?fileId=" + currentFileId;
            e.preventDefault();
        }
    }

    // --- Core: Fetch and Render Related Docs (GRID) ---
    const fetchRelatedFiles = async () => { 
        if (relatedGrid) {
            relatedGrid.innerHTML = `<p id="gridLoading" class="text-dark ps-2">Loading similar files...</p>`;
        }

        try {
            const response = await fetch(`/products/related?fileId=${currentFileId}`);
            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
            
            const relatedDocs = await response.json();
            
            // Render ALL related documents directly into the grid
            if (relatedDocs && relatedDocs.length > 0) {
                const allCardsHTML = relatedDocs.map(doc => renderFileCardJS(doc)).join(''); 
                if (relatedGrid) relatedGrid.innerHTML = allCardsHTML;
            } else {
                if (relatedGrid) relatedGrid.innerHTML = '<p class="text-dark ps-2">No related files found.</p>';
            }
            
        } catch (error) {
            console.error("Error fetching related files:", error);
            if (relatedGrid) relatedGrid.innerHTML = '<p class="text-danger ps-2">Error loading files.</p>';
        }
    };

    // --- Initial Load for Grid ---
    fetchRelatedFiles();
}); 
    </script>

</body>

</html>