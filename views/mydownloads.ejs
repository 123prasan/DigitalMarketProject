<%-include("header")%>
<div class="downloads-component-scope-xyz">
    
    <div class="downloads-component__container">
        <div class="downloads-component__card">
            <div class="downloads-component__header">
                <h1 class="downloads-component__title">My Downloads</h1>
                <div class="downloads-component__logo-icon">
                    <img class="downloads-component__logo-img" src="https://upload.wikimedia.org/wikipedia/commons/a/a7/React-icon.svg" alt="Brand Logo">
                </div>
            </div>

            <div class="downloads-component__search-bar">
                <i class="fa-solid fa-search downloads-component__search-icon"></i>
                <input type="search" id="downloadsSearchInput" class="downloads-component__search-input"
                    placeholder="Search by filename...">
            </div>

            <div class="downloads-component__filter-bar">
                <div class="downloads-component__filter-group">
                    <label for="fileTypeFilter" class="downloads-component__filter-label">File Type</label>
                    <select id="downloadsFileTypeFilter" class="downloads-component__filter-select">
                        <option value="all">All Types</option>
                    </select>
                </div>
                 <div class="downloads-component__filter-group">
                    <label for="startDateFilter" class="downloads-component__filter-label">Start Date</label>
                    <input type="date" id="downloadsStartDateFilter" class="downloads-component__filter-input">
                </div>
                 <div class="downloads-component__filter-group">
                    <label for="endDateFilter" class="downloads-component__filter-label">End Date</label>
                    <input type="date" id="downloadsEndDateFilter" class="downloads-component__filter-input">
                </div>
            </div>

            <ul class="downloads-component__list" id="downloadsListComponent">
                <%# The content of this list will be rendered by client-side JavaScript %>
            </ul>
        </div>
    </div>

</div>

<style>
    /* * All styles are scoped within .downloads-component-scope-xyz 
     * to prevent affecting any other elements on the page,
     * including the header and footer.
    */
    .downloads-component-scope-xyz {
        /* Scoped CSS variables moved from :root */
        --bg-primary: #0a0a0a;
        --bg-secondary: #141414;
        --bg-card: #1a1a1a;
        --bg-input: #2a2a2a;
        --bg-hover: #222222;
        --text-primary: #f0f0f0;
        --text-secondary: #a0a0a0;
        --text-muted: #666666;
        --accent-primary: #6366f1;
        --accent-hover: #4f46e5;
        --border-color: #333333;
        --border-focus: #6366f1;
        --shadow-glow: 0 0 25px -5px rgba(99, 102, 241, 0.2);
        --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        --border-radius-lg: 16px;
        --border-radius-md: 8px;
        --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);

        height: 100%;
        width: 100%;
        font-family: var(--font-family);
        background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        color: var(--text-primary);
        display: flex;
        flex-direction: column;
    }

    .downloads-component-scope-xyz * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    .downloads-component-scope-xyz .downloads-component__container {
        width: 100%;
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        /* padding: 2rem; */
    }

    .downloads-component-scope-xyz .downloads-component__card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        padding: 40px;
        box-shadow: var(--shadow-glow);
        width: 100%;
        /* max-width: 900px; */
        animation: downloads-component-fadeIn 0.6s ease-out;
        display: flex;
        flex-direction: column;
        max-height: calc(100vh - 40px);
    }

    @keyframes downloads-component-fadeIn {
        from { opacity: 0; transform: translateY(10px) scale(0.98); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .downloads-component-scope-xyz .downloads-component__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
    }

    .downloads-component-scope-xyz .downloads-component__title {
        font-size: 28px;
        font-weight: 700;
    }

    .downloads-component-scope-xyz .downloads-component__logo-icon {
        height: 36px;
    }
    .downloads-component-scope-xyz .downloads-component__logo-img {
        height: 100%;
        filter: invert(1);
    }

    .downloads-component-scope-xyz .downloads-component__search-bar {
        position: relative;
        width: 100%;
        margin-bottom: 16px;
        flex-shrink: 0;
    }
    .downloads-component-scope-xyz .downloads-component__search-icon {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
    }
    .downloads-component-scope-xyz .downloads-component__search-input {
        width: 100%;
        padding: 14px 16px 14px 44px;
        background-color: var(--bg-input);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-md);
        color: var(--text-primary);
        font-size: 16px;
        outline: none;
        transition: border-color var(--transition), box-shadow var(--transition);
    }

    .downloads-component-scope-xyz .downloads-component__search-input:focus {
        border-color: var(--border-focus);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    .downloads-component-scope-xyz .downloads-component__filter-bar {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
        flex-shrink: 0;
    }
    .downloads-component-scope-xyz .downloads-component__filter-group {
        display: flex;
        flex-direction: column;
    }
    .downloads-component-scope-xyz .downloads-component__filter-label {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 8px;
        font-weight: 500;
    }
    .downloads-component-scope-xyz .downloads-component__filter-select, 
    .downloads-component-scope-xyz .downloads-component__filter-input {
        padding: 10px;
        background-color: var(--bg-input);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-md);
        color: var(--text-primary);
        font-size: 14px;
        -webkit-appearance: none;
    }

    .downloads-component-scope-xyz .downloads-component__list {
        list-style: none;
        overflow-y: auto;
        padding-right: 12px;
        flex-grow: 1;
    }

    .downloads-component-scope-xyz .downloads-component__list-message {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }
    .downloads-component-scope-xyz .downloads-component__list-message-icon {
        font-size: 48px;
        margin-bottom: 16px;
        display: block;
    }
    .downloads-component-scope-xyz .downloads-component__list::-webkit-scrollbar { width: 8px; }
    .downloads-component-scope-xyz .downloads-component__list::-webkit-scrollbar-track { background: transparent; }
    .downloads-component-scope-xyz .downloads-component__list::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
    .downloads-component-scope-xyz .downloads-component__list::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    .downloads-component-scope-xyz .downloads-component__item {
        display: flex;
        align-items: center;
        padding: 16px 8px;
        border-radius: var(--border-radius-md);
        transition: background-color var(--transition);
        gap: 16px;
        border-bottom: 1px solid var(--border-color);
    }

    @keyframes downloads-component-slideInFade {
        from { opacity: 0; transform: translateX(-10px); }
        to { opacity: 1; transform: translateX(0); }
    }
    .downloads-component-scope-xyz .downloads-component__item.animate-in {
        animation: downloads-component-slideInFade 0.4s ease-out forwards;
    }

    .downloads-component-scope-xyz .downloads-component__item:hover {
        background-color: var(--bg-hover);
    }

    .downloads-component-scope-xyz .downloads-component__file-icon-wrapper {
        flex-shrink: 0;
        width: 48px;
        height: 48px;
        background-color: var(--bg-input);
        border-radius: var(--border-radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        color: var(--accent-primary);
    }
    .downloads-component-scope-xyz .downloads-component__file-info { flex-grow: 1; min-width: 0; }
    .downloads-component-scope-xyz .downloads-component__file-name {
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 16px;
    }
    .downloads-component-scope-xyz .downloads-component__download-date { font-size: 13px; color: var(--text-secondary); }

    .downloads-component-scope-xyz .downloads-component__redownload-btn {
        flex-shrink: 0;
        padding: 8px 16px;
        background-color: var(--bg-input);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-md);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .downloads-component-scope-xyz .downloads-component__redownload-btn:hover {
        background-color: var(--accent-primary);
        color: var(--text-primary);
        border-color: var(--accent-primary);
    }
    .downloads-component-scope-xyz .downloads-component__redownload-btn-icon {
        /* Class for the icon inside the button if needed */
    }
     .downloads-component-scope-xyz .downloads-component__redownload-btn-text {
        /* Class for the text inside the button if needed */
    }

</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM ELEMENTS ---
        const downloadsList = document.getElementById('downloadsListComponent');
        const searchInput = document.getElementById('downloadsSearchInput');
        const fileTypeFilter = document.getElementById('downloadsFileTypeFilter');
        const startDateFilter = document.getElementById('downloadsStartDateFilter');
        const endDateFilter = document.getElementById('downloadsEndDateFilter');

        // --- DATA HYDRATION ---
        const allDownloads = <%-JSON.stringify(downloads)%>;

        // --- STATE ---
        const filters = {
            query: '',
            fileType: 'all',
            startDate: null,
            endDate: null
        };

        // --- UTILITY FUNCTIONS ---
        const getFileIconClass = (filename = '') => {
            const extension = filename.split('.').pop().toLowerCase();
            switch (extension) {
                case 'pdf': return 'fa-solid fa-file-pdf';
                case 'zip': case 'rar': return 'fa-solid fa-file-zipper';
                case 'xlsx': case 'csv': return 'fa-solid fa-file-excel';
                case 'ppt': case 'pptx': return 'fa-solid fa-file-powerpoint';
                case 'doc': case 'docx': return 'fa-solid fa-file-word';
                case 'jpg': case 'jpeg': case 'png': case 'gif': return 'fa-solid fa-file-image';
                default: return 'fa-solid fa-file';
            }
        };

        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };

        // --- RENDER FUNCTION ---
        const renderDownloads = (files) => {
            downloadsList.innerHTML = '';
            if (files.length === 0) {
                downloadsList.innerHTML = `<li class="downloads-component__list-message"><i class="fa-solid fa-box-open downloads-component__list-message-icon"></i>No files match your filters.</li>`;
                return;
            }

            const fragment = document.createDocumentFragment();
            files.forEach((file, index) => {
                const item = document.createElement('li');
                // **UPDATED** to use unique class
                item.className = 'downloads-component__item';
                item.style.animationDelay = `${index * 50}ms`;
                
                const downloadDate = new Date(file.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });

                // **UPDATED** to use unique classes
                item.innerHTML = `
                    <div class="downloads-component__file-icon-wrapper"><i class="${getFileIconClass(file.filename)}"></i></div>
                    <div class="downloads-component__file-info">
                        <div class="downloads-component__file-name" title="${file.filename}">${file.filename}</div>
                        <div class="downloads-component__download-date">Downloaded on: ${downloadDate}</div>
                    </div>
                    <a href="/download/?file_id=${file.fileId}" class="downloads-component__redownload-btn">
                        <i class="fa-solid fa-download downloads-component__redownload-btn-icon"></i>
                        <span class="downloads-component__redownload-btn-text">Redownload</span>
                    </a>
                `;
                fragment.appendChild(item);
            });
            downloadsList.appendChild(fragment);

            setTimeout(() => {
                const items = downloadsList.querySelectorAll('.downloads-component__item');
                items.forEach(item => item.classList.add('animate-in'));
            }, 10);
        };

        // --- FILTERING LOGIC ---
        const applyFiltersAndRender = () => {
            let filteredFiles = allDownloads;

            if (filters.query) {
                filteredFiles = filteredFiles.filter(file =>
                    file.filename.toLowerCase().includes(filters.query)
                );
            }

            if (filters.fileType !== 'all') {
                 filteredFiles = filteredFiles.filter(file => {
                    const extension = file.filename.split('.').pop().toLowerCase();
                    return extension === filters.fileType;
                });
            }

            if (filters.startDate) {
                filteredFiles = filteredFiles.filter(file => new Date(file.createdAt) >= filters.startDate);
            }
            if (filters.endDate) {
                const inclusiveEndDate = new Date(filters.endDate);
                inclusiveEndDate.setDate(inclusiveEndDate.getDate() + 1);
                filteredFiles = filteredFiles.filter(file => new Date(file.createdAt) < inclusiveEndDate);
            }
            
            renderDownloads(filteredFiles);
        };

        // --- DYNAMIC FILTER POPULATION ---
        const populateFileTypeFilter = () => {
            const fileTypes = [...new Set(allDownloads.map(file => file.filename.split('.').pop().toLowerCase()))];
            fileTypes.sort().forEach(type => {
                 if(type) {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = `.${type.toUpperCase()}`;
                    fileTypeFilter.appendChild(option);
                 }
            });
        };
        
        // --- EVENT LISTENERS ---
        searchInput.addEventListener('input', debounce((e) => {
            filters.query = e.target.value.toLowerCase();
            applyFiltersAndRender();
        }, 300));
        
        fileTypeFilter.addEventListener('change', (e) => {
            filters.fileType = e.target.value;
            applyFiltersAndRender();
        });

        startDateFilter.addEventListener('change', (e) => {
            filters.startDate = e.target.value ? new Date(e.target.value) : null;
            applyFiltersAndRender();
        });

        endDateFilter.addEventListener('change', (e) => {
            filters.endDate = e.target.value ? new Date(e.target.value) : null;
            applyFiltersAndRender();
        });

        // --- INITIAL LOAD ---
        if (allDownloads && allDownloads.length > 0) {
            populateFileTypeFilter();
            renderDownloads(allDownloads);
        } else {
            downloadsList.innerHTML = `<li class="downloads-component__list-message"><i class="fa-solid fa-cloud-download downloads-component__list-message-icon"></i>You have not downloaded any files yet.</li>`;
        }
    });
</script>
<%-include("footer")%>